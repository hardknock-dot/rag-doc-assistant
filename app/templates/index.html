<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>RAG QA</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>RAG Doc Assistant</h1>
        <input id="question" type="text" placeholder="Ask a question..." />
        <!-- Inside your .card div -->
        <div id="answer" class="answer"></div>

        <div id="chatHistory" class="chat-history"></div>

        <div style="margin-top: 12px">
          <button id="askBtn">Ask</button>
        </div>
        
        <input type="file" id="pdfUpload" />
        <button id="uploadBtn">Upload PDF</button>
        <!-- <div id="sources" class="sources"></div> -->
      </div>
    </div>

    <script>
            async function askQuestion() {
              const q = document.getElementById("question").value;
              if (!q) return;
              document.getElementById("answer").innerText = "Thinking...";
              const res = await fetch("/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: q }),
              });
              const data = await res.json();
              if (data.error) {
                document.getElementById("answer").innerText = "Error: " + data.error;
                return;
              }
              document.getElementById("answer").innerText =
                data.answer || "No answer";
              const srcElem = document.getElementById("sources");
              srcElem.innerHTML = "";
              (data.sources || []).forEach((s) => {
                const div = document.createElement("div");
                div.className = "source";
                div.innerHTML = `<strong>${s.source}</strong><div>${s.snippet}</div>`;
                srcElem.appendChild(div);
              });
            }

            document.getElementById("askBtn").addEventListener("click", askQuestion);
            document
              .getElementById("question")
              .addEventListener("keydown", function (e) {
                if (e.key === "Enter") askQuestion();
              });

              document.getElementById("uploadBtn").addEventListener("click", async () => {
        const fileInput = document.getElementById("pdfUpload");
        if (fileInput.files.length === 0) return;
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        const res = await fetch("/upload", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        alert(data.success || data.error);
      });

    //   function updateChatHistory() {
    //     const chatDiv = document.getElementById("chatHistory");
    //     chatDiv.innerHTML = "";
    //     const history = {{ chat_history | tojson }};
    //     history.forEach(item => {
    //       const q = document.createElement("div");
    //       q.className = "question";
    //       q.innerText = "Q: " + item.question;
    //       const a = document.createElement("div");
    //       a.className = "answer";
    //       a.innerText = "A: " + item.answer;
    //       chatDiv.appendChild(q);
    //       chatDiv.appendChild(a);
    //     });
    //   }

      // call updateChatHistory() on page load
      updateChatHistory();
    </script>
  </body>
</html>
